<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="mondrians.css">
  <title>Mondrian</title>
</head>

<body>
  <form autocomplete="off">
    <label for="seed">Graine: </label><input type="text" name="seed" id="seed">
    <button id="randomFill">Générer une graine aléatoire</button><br>
    <label for="width">Largeur: </label><input type="number" name="width" id="width" min="10" max="5000"
      value="1920"><br>
    <label for="height">Hauteur: </label><input type="number" name="height" id="height" min="10" max="5000"
      value="1080"><br>
    <label for="sep-width">Largeur des séparateurs: </label><input type="number" name="sep-width" id="sep-width" min="1"
      max="100" value="5"><br>
    <label for="max-depth">Profondeur maximale: </label><input type="number" name="max-depth" id="max-depth" min="1"
      max="10" value="5"><br>
    <label for="min-middle">Millieu minimum: </label><input type="number" name="min-middle" id="min-middle" min="1"
      max="100" value="20"><br>
    <label for="max-middle">Millieu maximum: </label><input type="number" name="max-middle" id="max-middle" min="1"
      max="100" value="80"><br>
    <input type="submit" value="Générer" id="generate">
  </form>

  <img id="output" alt="Tableau généré dans le style de Mondrian" hidden></img>


  <script>
    const form = document.querySelector("form");
    const output = document.querySelector("img#output");
    const status = document.querySelector("input#generate");
    const ramdomFill = document.querySelector("button#randomFill");
    const seed = document.querySelector("input#seed");
    var generating = false;
    var toGenerate = null;
    var erroring = false;
    status.disabled = true;
    status.value = "Chargement en cours...";

    var worker = new Worker("worker.js");

    function workerOnError(error) {
      console.log(`Worker error: ${error.message}`);
      status.disabled = false;
      status.value = "Erreur lors de la génération, modifiez les paramètres et réessayez";
      erroring = true;
      toGenerate = null;
      generating = false;
      worker.terminate();
      setTimeout(() => { worker = new Worker("worker.js"); worker.onerror = workerOnError; worker.onmessage = workerOnMessage; erroring = false; }, 1);
      throw error;
    }

    function workerOnMessage(event) {
      if (toGenerate != null) {
        worker.postMessage(toGenerate);
        toGenerate = null;
      } else {
        generating = false;
        status.disabled = false;
        status.value = "Générer";
      }
      output.src = ("data:image/png;base64," + event.data.data);
      output.hidden = false;
    };

    worker.onerror = workerOnError;
    worker.onmessage = workerOnMessage;

    randomFill.onclick = (e) => {
      const random = (length = 8) => {
        // Declare all characters
        let chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

        // Pick characers randomly
        let str = '';
        for (let i = 0; i < length; i++) {
          str += chars.charAt(Math.floor(Math.random() * chars.length));
        }

        return str;

      };
      seed.value = random();

    };

    form.onsubmit = (e) => {
      e.preventDefault();
      main();
    }

    form.oninput = (e) => {
      main();
    };

    function generate(seed, width, height, max_depth, sep_width, min_middle, max_middle) {
      if (generating) {
        toGenerate = { seed: seed, width: width, height: height, max_depth: max_depth, sep_width: sep_width, min_middle: min_middle, max_middle: max_middle };
      } else {
        worker.postMessage({ seed: seed, width: width, height: height, max_depth: max_depth, sep_width: sep_width, min_middle: min_middle, max_middle: max_middle });
        generating = true;
      }

    }

    function main() {
      if (!form.checkValidity()) {
        return;
      }
      if (erroring) {
        setTimeout(main, 10);
      }
      status.disabled = true;
      status.value = "Génération en cours...";
      generate(Uint8Array.from(document.getElementById("seed").value), Number.parseInt(document.getElementById("width").value), Number.parseInt(document.getElementById("height").value), Number.parseInt(document.getElementById("max-depth").value), Number.parseInt(document.getElementById("sep-width").value), Number.parseInt(document.getElementById("min-middle").value), Number.parseInt(document.getElementById("max-middle").value));
    }

    main()

  </script>
</body>

</html>